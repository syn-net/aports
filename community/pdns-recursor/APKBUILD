# Contributor: JEFFREY CARPENTER <i8degrees@gmail.com>
#
# NOTE(jeff): This file is derived from the apports tree [1].
# 1. https://git.alpinelinux.org/aports/tree/community/pdns-recursor/APKBUILD?h=3.18-stable

_pkgver=5.0.0-rc1
# Maintainer: Peter van Dijk <peter.van.dijk@powerdns.com>
_pkgname=pdns-recursor # upstream package name
pkgname=pdns-recursor
pkgver=5.0.0
pkgrel=0
pkgdesc="PowerDNS Recursive Server"
url="https://www.powerdns.com/"
arch="all !s390x" # broken context
license="GPL-2.0-only WITH OpenSSL-Exception"
makedepends="autoconf automake libtool boost-dev openssl-dev>3 libsodium-dev net-snmp-dev curl curl-dev cargo luajit-dev make openssl-dev"
depends="boost1.82-context boost1.82-filesystem busybox-binsh libcrypto3 libcurl libgcc libsodium libssl3 libstdc++ lua5.3-libs musl net-snmp-agent-libs net-snmp-libs"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-openrc"
pkgusers="recursor"
pkggroups="recursor"
source="https://downloads.powerdns.com/releases/${_pkgname}-${_pkgver}.tar.bz2
	$_pkgname.initd
	recursor.conf
	"

builddir="${srcdir}/${_pkgname}-${_pkgver}"

[ "$CARCH" = "riscv64" ] && options="$options textrels"

build() {
  
  #--enable-unit-tests \
  ./configure --prefix=/usr \
  	--sysconfdir=/etc/pdns \
	--mandir=/usr/share/man \
	--infodir=/usr/share/info \
	--localstatedir=/var \
	--libdir=/usr/lib/pdns \
	--enable-dns-over-tls
  	#--enable-unit-tests
  make -j6
}
check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	mv "$pkgdir"/etc/pdns/recursor.conf-dist  "$pkgdir"/etc/pdns/recursor.conf
	cat "$srcdir/recursor.conf" >> "$pkgdir"/etc/pdns/recursor.conf

	install -m755 -D "$srcdir/$_pkgname.initd" \
		"$pkgdir/etc/init.d/$pkgname"

}

sha512sums="
334eb1fcdaca6d822f3f6ba5b497a2cf9985220f34a7db7fbd7bc8a2efef60e584d4eaa08107809d54fd2471bfa5c16ad7e2d03043180a59c7eb6eab51ab8cbd  pdns-recursor-5.0.0-rc1.tar.bz2
71f7be51d3a9a78f22f3946e95534d4f5b37b3bcbd1891ad3a17095be545fdb0eaf239d58c9f40ccc642542150c0b35ed025bf69acabfa779c0ab10c67a5e796  pdns-recursor.initd
abda278d29b21e9635fb154c8685e5d346f47889498f075a8dd2e486f8ea4dcc2ccd20f4245783e4d55534fed88c49825b22fd3d1c55d8645522ce45cc53d661  recursor.conf
"
